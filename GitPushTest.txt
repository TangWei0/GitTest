▼Gerritサーバコミットメモ

▽Amethyst本線登録までの流れ
1.Gerritサーバ登録
↓
2.レビュー
↓
3.本線登録orやり直し

ここでは1.Gerritサーバ登録について記載する



▽事前準備
Gerritサーバユーザ登録を済ませ下記にログインできること
[Gitリポジトリ/Gerritレビューシステムサーバー（Gerrit）]
https://aries.psn-dom.pbs-itsv.com

※ユーザアカウントはOwncloudやJIRAやイメージサーバと一緒



▽ターミナル作業(repo init でソース取得していることを想定)
＃ 以下"＃"が先頭にある行や"---"で囲った箇所は補足なので読み飛ばしても大丈夫です

0.ソース取得
 repo init -u https://aries.psn-dom.pbs-itsv.com/platform/manifest.git -b amethyst-lp -m amethyst-lp-12-0NNN.xml
 repo sync
↓

1.ローカルブランチ確認
 git branch
 
＃ * (no branch) と出ていたら"git checkout -b <new branch>"でローカルブランチ作成＋切り替え
＃ 下記は"amethyst-lp"ブランチを作成＋切り替えた例である
＃ git checkout -b amethyst-lp
↓

2.ソース修正
 適宜

＃ この段階で"git status" と打つと下記のように表示される
＃ 下記は"panasonic_sepolicy.mk"を修正
＃ "adbd.te"を新規追加した例である
---
# On branch amethyst-lp
# Changes not staged for commit:
#   (use "git add <file>..." to update what will be committed)
#   (use "git checkout -- <file>..." to discard changes in working directory)
#
#       modified:   sepolicy/panasonic_sepolicy.mk
#
# Untracked files:
#   (use "git add <file>..." to include in what will be committed)
#
#       sepolicy/adbd.te
#
no changes added to commit (use "git add" and/or "git commit -a")
---
↓

3.Change-Idをコミットメッセージに埋め込む設定("commit-msg"を".git/hooks"配下に取得)
 cd .git/hooks
 wget https://aries.psn-dom.pbs-itsv.com/tools/hooks/commit-msg
 chmod +x commit-msg

＃ wgetログは下記のようになる
---
--2016-06-01 09:32:56--  https://aries.psn-dom.pbs-itsv.com/tools/hooks/commit-msg
Resolving aries.psn-dom.pbs-itsv.com (aries.psn-dom.pbs-itsv.com)... 54.238.237.161
Connecting to aries.psn-dom.pbs-itsv.com (aries.psn-dom.pbs-itsv.com)|54.238.237.161|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4361 (4.3K) [application/octet-stream]
Saving to: `commit-msg'

100%[==================================================================>] 4,361       --.-K/s   in 0s

2016-06-01 09:32:56 (174 MB/s) - `commit-msg' saved [4361/4361]
---

＃コミットログにChange-IdをいれないとGerritにpushできない
＃git reset --soft HEAD^ で直前コミットのリセット対応をとる必要がある
---
Counting objects: 5, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 711 bytes | 0 bytes/s, done.
Total 5 (delta 3), reused 0 (delta 0)
remote: Resolving deltas: 100% (3/3)
remote: Processing changes: refs: 1, done
remote: ERROR: missing Change-Id in commit message footer
remote: Suggestion for commit message:
remote:     Secure: Add SELinux policy
remote:
remote:     Type:Other
remote:     Src:Open
remote:     Add temporary policy for RIDL and thermal_device
remote:
remote: Change-Id: Ifeb0e724a6323f3e73225d4fcc431b086a236085
remote:
remote: Hint: To automatically insert Change-Id, install the hook:
remote:   gitdir=$(git rev-parse --git-dir); scp -p -P 29418 ymochid2.nsw@aries.psn-dom.pbs-itsv.com:hooks/commit-msg ${gitdir}/hooks/
remote:
remote:
To https://aries.psn-dom.pbs-itsv.com/platform/device/panasonic/amethyst
 ! [remote rejected] HEAD -> refs/for/amethyst-lp (missing Change-Id in commit message footer)
error: failed to push some refs to 'https://aries.psn-dom.pbs-itsv.com/platform/device/panasonic/amethyst'
---
↓

4.ステージング(コミット前確認)
 git add .

＃ この段階で"git status" と打つと下記のように表示される
＃ 下記は"panasonic_sepolicy.mk"を修正
＃ "adbd.te"を新規追加した例である
---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git add .
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git status
# On branch amethyst-lp
# Changes to be committed:
#   (use "git reset HEAD <file>..." to unstage)
#
#       new file:   sepolicy/adbd.te
#       modified:   sepolicy/panasonic_sepolicy.mk
#
---
↓

5.コミット
 git commit

＃ ログ記載画面がviで開くのでルールに従って記載
＃ ログ記載ルールについては"【依頼事項】commitメッセージ記入ルール_r7.pptx"を参照のこと
＃ ":wq"で保存するとコミットが開始される
＃ コミット後"git log"でログを確認すると3.で取得したスクリプトにより
＃ "Change-Id: XXXXXX..." が自動挿入される
---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git commit
[amethyst-lp 5134a05]     Secure: Add SELinux policy
 2 files changed, 5 insertions(+), 1 deletion(-)
 create mode 100644 sepolicy/adbd.te
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git log
commit 5134a051df02d72a449f11edce1d62b1c7742eab
Author: ymochid2.nsw <ymochid2@gw.nsw.co.jp>
Date:   Wed Jun 1 09:40:02 2016 +0900

        Secure: Add SELinux policy

        Type:Other
        Src:Open
        Add policy to SELinuxLog files in "/data/log"

    Change-Id: Ic059620deb3c4e91659b8c508681e2bf32047849

commit 96ede49a997b61457486bd27d31e9f273df80b07
Merge: d02059c 5886b0a
Author: uchimi.tomohide <uchimi.tomohide@jp.panasonic.com>
Date:   Wed May 25 11:17:46 2016 +0900

---
↓

6.Gerritサーバにプッシュ
 git push aries HEAD:refs/for/amethyst-lp

---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git push aries HEAD:refs/for/amethyst-lp
Counting objects: 5, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 589 bytes | 0 bytes/s, done.
Total 5 (delta 3), reused 0 (delta 0)
remote: Resolving deltas: 100% (3/3)
remote: Processing changes: new: 1, refs: 1, done
remote:
remote: New Changes:
remote:   https://aries.psn-dom.pbs-itsv.com/1330
remote:
To https://aries.psn-dom.pbs-itsv.com/platform/device/panasonic/amethyst
 * [new branch]      HEAD -> refs/for/amethyst-lp
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$
---



▽Gerrit Web レビューシステム作業
1.レビュー画面表示(Gerritサーバのログイン必須)
push時のログのURLにアクセス
https://aries.psn-dom.pbs-itsv.com/XXXX
↓

2.レビューワの設定
"•Need Code-Review"の下にメアド等を入れて"Add Reviewer"押下

＃ Amethystでは２人以上設定する必要がある、らしい
＃ レビューワに設定できない人もいるみたい(エラー出る)



以上により、設定したレビューワとGerrit Web にて Watched Projectにイベント設定したユーザに対して
レビューに向けて変更イベントが発生したことがメールで通知される、はず
(変更者本人には通知が来ないので未確認)





▼Gerritサーバコミットメモ_競合時(暫定対処・新規Gerrit登録)
レビュー承認後に登録者が本線に登録しようとして(Gerrit Web で "Submit Patch Set NN"ボタン押下)
下記エラーが出た場合の対応
---
Gerrit Code Review  
The change could not be merged due to a path conflict.
Please rebase the change locally and upload the rebased commit for review.
---

0.マージ用ローカルブランチ作成(なんとなく)
 git checkout -b amethyst-lp-merge
↓

1.ローカルブランチを本線ブランチの最新にする(CONFLICTが発生する、はず)
 git fetch aries
 git rebase aries/amethyst-lp

＃ リモートリポジトリ：aries
＃ 本線ブランチ：aries/amethyst-lp
＃ 
---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git fetch aries
remote: Counting objects: 79, done
remote: Finding sources: 100% (57/57)
remote: Total 57 (delta 28), reused 50 (delta 28)
Unpacking objects: 100% (57/57), done.
From https://aries.psn-dom.pbs-itsv.com/platform/device/panasonic/amethyst
   eec0cb7..def0e7d  amethyst-lp -> aries/amethyst-lp
 * [new branch]      amethyst-lp-12-0060-pftm -> aries/amethyst-lp-12-0060-pftm
 * [new tag]         amethyst-lp-12-0061 -> amethyst-lp-12-0061
 * [new tag]         amethyst-lp-12-0064 -> amethyst-lp-12-0064
 * [new tag]         amethyst-pftm-006001 -> amethyst-pftm-006001
 * [new tag]         amethyst-lp-12-0062 -> amethyst-lp-12-0062
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git rebase aries/amethyst-lp
First, rewinding head to replay your work on top of it...
Applying:     Secure: Add SELinux policy
Using index info to reconstruct a base tree...
M       sepolicy/panasonic_sepolicy.mk
.git/rebase-apply/patch:20: trailing whitespace.
       adbd.te
warning: 1 line adds whitespace errors.
Falling back to patching base and 3-way merge...
Auto-merging sepolicy/panasonic_sepolicy.mk
CONFLICT (content): Merge conflict in sepolicy/panasonic_sepolicy.mk
Recorded preimage for 'sepolicy/panasonic_sepolicy.mk'
error: Failed to merge in the changes.
Patch failed at 0001     Secure: Add SELinux policy
The copy of the patch that failed is found in: .git/rebase-apply/patch

When you have resolved this problem, run "git rebase --continue".
If you prefer to skip this patch, run "git rebase --skip" instead.
To check out the original branch and stop rebasing, run "git rebase --abort".

ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git diff
diff --cc sepolicy/panasonic_sepolicy.mk
index 2994b16,ce5b69f..0000000
--- a/sepolicy/panasonic_sepolicy.mk
+++ b/sepolicy/panasonic_sepolicy.mk
@@@ -17,8 -17,8 +17,13 @@@ BOARD_SEPOLICY_UNION +=
         recovery.te \
         fotaservice.te \
         nfc.te \
++<<<<<<< def0e7dc6e9f029fa57aeee80880898fd19a653c
 +       btkm_daemon.te \
 +       shell.te
++=======
+        shell.te \
+        adbd.te
++>>>>>>>     Secure: Add SELinux policy

  ifeq ($(TARGET_ADB_ROOT),on)
  BOARD_SEPOLICY_UNION += \
---


2.競合対応
 適宜


3.ステージング
 git add [修正したファイル名]

---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git status
# rebase in progress; onto def0e7d
# You are currently rebasing branch 'amethyst-lp-merge' on 'def0e7d'.
#   (fix conflicts and then run "git rebase --continue")
#   (use "git rebase --skip" to skip this patch)
#   (use "git rebase --abort" to check out the original branch)
#
# Changes to be committed:
#   (use "git reset HEAD <file>..." to unstage)
#
#       new file:   sepolicy/adbd.te
#
# Unmerged paths:
#   (use "git reset HEAD <file>..." to unstage)
#   (use "git add <file>..." to mark resolution)
#
#       both modified:   sepolicy/panasonic_sepolicy.mk
#
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git add sepolicy/panasonic_sepolicy.mk
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git status
# rebase in progress; onto def0e7d
# You are currently rebasing branch 'amethyst-lp-merge' on 'def0e7d'.
#   (all conflicts fixed: run "git rebase --continue")
#
# Changes to be committed:
#   (use "git reset HEAD <file>..." to unstage)
#
#       new file:   sepolicy/adbd.te
#       modified:   sepolicy/panasonic_sepolicy.mk
#
---
↓

4.コミット
 git commit

＃Change-Id:が前と変わってる、、、
＃要調査
---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git commit
Recorded resolution for 'sepolicy/panasonic_sepolicy.mk'.
[detached HEAD f5b66ad]     Secure: Add SELinux policy
 2 files changed, 5 insertions(+), 1 deletion(-)
 create mode 100644 sepolicy/adbd.te
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git log
commit f5b66ad846c125e8ece3253386768db7708a8773
Author: ymochid2.nsw <ymochid2@gw.nsw.co.jp>
Date:   Thu Jun 2 16:48:48 2016 +0900

        Secure: Add SELinux policy

        Type:Other
        Src:Open
        Add policy pull to SELinuxLog files in "/data/log"

    Change-Id: Ibee62f4b669d0e247648f37a5cb65c7ceda55b8d

commit def0e7dc6e9f029fa57aeee80880898fd19a653c
---


5.Gerritサーバにpush

＃新しいGerritになってしまった、、、
＃要調査
---
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$ git push aries HEAD:refs/for/amethyst-lp
Counting objects: 5, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (5/5), done.
Writing objects: 100% (5/5), 596 bytes | 0 bytes/s, done.
Total 5 (delta 3), reused 0 (delta 0)
remote: Resolving deltas: 100% (3/3)
remote: Processing changes: new: 1, refs: 1, done
remote:
remote: New Changes:
remote:   https://aries.psn-dom.pbs-itsv.com/1351
remote:
To https://aries.psn-dom.pbs-itsv.com/platform/device/panasonic/amethyst
 * [new branch]      HEAD -> refs/for/amethyst-lp
ymochid2@04394830:~/_src/amethyst-lp-12-0060/device/panasonic/test11$
---

